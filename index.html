<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feel Understood - Self Assessment</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial; background: #fff; color: #121212; }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const App = () => {
      const [step, setStep] = React.useState(-1);
      const [responses, setResponses] = React.useState({});
      const [showResults, setShowResults] = React.useState(false);
      const [aiAnalysis, setAiAnalysis] = React.useState(null);
      const [isGenerating, setIsGenerating] = React.useState(false);
      
      const questions = [
        {
          id: 'general',
          text: 'When you consider the totality of your relationships, how accurately would you say people understand who you fundamentally are?',
          options: ['People see me with remarkable clarity', 'Most people understand the essential me', 'There is a noticeable gap between who I am and how I am perceived', 'I am frequently misunderstood in important ways', 'I feel profoundly unseen by those around me']
        },
        {
          id: 'frequency',
          text: 'In conversations that matter to you, how often do you experience that satisfying moment when someone truly gets what you are trying to communicate?',
          options: ['Almost always, it is a regular experience', 'Often enough that I count on it', 'Occasionally, but it feels special when it happens', 'Rarely, it is notable when someone understands', 'Almost never, I have largely stopped expecting it']
        },
        {
          id: 'support',
          type: 'multi',
          text: 'Which relationships in your life consistently provide you with a sense of being genuinely understood?',
          sub: 'Select all where you regularly feel seen and comprehended',
          options: ['Romantic partner or spouse', 'Parents or parental figures', 'Siblings', 'Close friends in person', 'Colleagues or work relationships', 'Online communities or virtual friendships', 'Therapist or counsellor', 'Extended family members', 'None of the above apply to me']
        },
        {
          id: 'context',
          text: 'In which domain of your life do you most acutely feel the absence of understanding, where the gap between your inner experience and others perceptions feels widest?',
          options: ['Professional life, my capabilities and contributions go unrecognised', 'Home and family, those closest to me misread who I am', 'Social settings, friends do not grasp my perspective', 'Intimate relationships, my partner does not see the real me', 'Community or public contexts, I am misunderstood by society at large', 'The gap feels relatively consistent across all domains']
        },
        {
          id: 'positive',
          type: 'multi',
          text: 'When someone demonstrates genuine understanding of you, what shifts in your experience?',
          sub: 'Select all that resonate with your actual experience',
          options: ['I feel psychologically safer and more willing to be vulnerable', 'The relationship deepens, I feel genuinely connected', 'My self-doubt diminishes, I trust my own perceptions more', 'I experience relief from the isolation of being alone with my thoughts', 'I become more authentic and less self-monitoring', 'I feel valued and respected as a person', 'My stress and anxiety levels decrease noticeably', 'Honestly, it does not create significant change for me']
        },
        {
          id: 'negative',
          type: 'multi',
          text: 'When you are misunderstood in ways that matter, what are the consequences in your inner life and behaviour?',
          sub: 'Select all that accurately describe your response',
          options: ['I withdraw emotionally and become less forthcoming', 'I question my own perceptions and experience self-doubt', 'I feel frustrated or angry at not being seen', 'The relationship loses intimacy and feels more superficial', 'I experience a sense of loneliness even when not alone', 'I feel disrespected or diminished as a person', 'My mental wellbeing deteriorates, increased anxiety or low mood', 'I become more defensive in future interactions', 'I actively distance myself from the relationship', 'It does not significantly impact me, I move on easily']
        },
        {
          id: 'values',
          type: 'rating',
          text: 'Your values, beliefs, and worldview',
          sub: 'Consider how well others understand your political views, spiritual or religious beliefs, ethical principles, what truly matters to you, and how you make sense of the world. To what degree do you feel misunderstood in this dimension of your identity?'
        },
        {
          id: 'personality',
          type: 'rating',
          text: 'Your personality and emotional nature',
          sub: 'Think about whether people grasp your temperament, your emotional needs, how you process experiences, your sense of humour, what energises or drains you, and your characteristic way of engaging with life. How misunderstood do you feel here?'
        },
        {
          id: 'preferences',
          type: 'rating',
          text: 'Your preferences and lifestyle choices',
          sub: 'Reflect on how others perceive your interests, passions, aesthetic tastes, social needs, how much interaction you want and need, and how you choose to spend your time and energy. Rate your sense of being misunderstood in this area.'
        },
        {
          id: 'motivations',
          type: 'rating',
          text: 'Your aspirations and what drives you',
          sub: 'Consider whether people comprehend your ambitions, career goals, personal aspirations, what motivates you daily, your creative impulses, and what you are ultimately working toward in life. How misunderstood are you here?'
        },
        {
          id: 'struggles',
          type: 'rating',
          text: 'Your challenges, vulnerabilities, and inner struggles',
          sub: 'Think about how well others understand your mental health experiences, physical health challenges, past experiences that have shaped you, your fears and anxieties, and what you find genuinely difficult. Rate the degree of misunderstanding.'
        },
        {
          id: 'capabilities',
          type: 'rating',
          text: 'Your capabilities and potential',
          sub: 'Reflect on whether people accurately perceive your abilities, skills, intelligence, potential for growth, and what you are truly capable of contributing. How misunderstood do you feel in this dimension?'
        },
        {
          id: 'responsibility',
          text: 'When you are not understood, where do you typically locate the responsibility?',
          sub: 'This reveals your implicit theory about how understanding works',
          options: ['Primarily my responsibility, I need to communicate more effectively', 'Mostly my responsibility, though context matters', 'Shared responsibility between both parties', 'Mostly the other person responsibility to listen better', 'Primarily their responsibility, if they cared, they would understand']
        },
        {
          id: 'expression',
          text: 'When you do not feel understood in a conversation, how often do you explicitly name this, saying something like I do not feel understood right now?',
          options: ['Regularly, it is part of how I communicate', 'Sometimes, when it really matters', 'Rarely, only in specific relationships or circumstances', 'Almost never, it feels too vulnerable or confrontational', 'Never, I keep that feeling to myself']
        },
        {
          id: 'awareness',
          text: 'How often do you discover that someone you thought understood you actually held significant misconceptions about who you are or what you meant?',
          sub: 'This assesses your awareness of false positives in understanding',
          options: ['Very frequently, it is a recurring pattern', 'Fairly often, it happens regularly enough to notice', 'Occasionally, it surprises me when it occurs', 'Rarely, my sense of being understood is usually accurate', 'Almost never, people generally understand me as I perceive']
        }
      ];
      
      const handleAnswer = (qid, val) => {
        setResponses({...responses, [qid]: val});
      };
      
      const handleMulti = (qid, opt) => {
        const curr = responses[qid] || [];
        const has = curr.includes(opt);
        const updated = has ? curr.filter(x => x !== opt) : [...curr, opt];
        setResponses({...responses, [qid]: updated});
      };
      
      const calculateResults = () => {
        const scores = {
          general: {'People see me with remarkable clarity': 100, 'Most people understand the essential me': 75, 'There is a noticeable gap between who I am and how I am perceived': 50, 'I am frequently misunderstood in important ways': 25, 'I feel profoundly unseen by those around me': 0}[responses.general] || 50,
          frequency: {'Almost always, it is a regular experience': 100, 'Often enough that I count on it': 75, 'Occasionally, but it feels special when it happens': 50, 'Rarely, it is notable when someone understands': 25, 'Almost never, I have largely stopped expecting it': 0}[responses.frequency] || 50
        };
        
        const overallQuality = (scores.general + scores.frequency) / 2;
        
        const identityScores = [
          responses.values || 5,
          responses.personality || 5,
          responses.preferences || 5,
          responses.motivations || 5,
          responses.struggles || 5,
          responses.capabilities || 5
        ];
        const avgIdentity = identityScores.reduce((a,b) => a+b, 0) / 6;
        
        const dims = [
          {name: 'Values and Beliefs', score: responses.values || 5},
          {name: 'Personality and Emotional Nature', score: responses.personality || 5},
          {name: 'Preferences and Lifestyle', score: responses.preferences || 5},
          {name: 'Aspirations and Motivations', score: responses.motivations || 5},
          {name: 'Challenges and Vulnerabilities', score: responses.struggles || 5},
          {name: 'Capabilities and Potential', score: responses.capabilities || 5}
        ].sort((a,b) => b.score - a.score);
        
        const supportCount = (responses.support || []).filter(s => s !== 'None of the above apply to me').length;
        const posCount = (responses.positive || []).length;
        const negCount = (responses.negative || []).length;
        
        return {
          overallQuality,
          avgIdentity,
          dims,
          supportCount,
          posCount,
          negCount,
          context: responses.context
        };
      };
      
      const generateAIAnalysis = async (results) => {
        setIsGenerating(true);
        
        const prompt = `You are analyzing responses from a "Feeling Understood" self-assessment survey. Based on the person's complete response pattern, provide deep, personalized insights that go beyond the quantitative scores.

QUANTITATIVE SCORES:
- Overall Understanding Quality: ${Math.round(results.overallQuality)}%
- Average Identity Misunderstanding: ${results.avgIdentity.toFixed(1)}/10
- Support Network Size: ${results.supportCount} relationships
- Positive Effects Count: ${results.posCount}
- Negative Effects Count: ${results.negCount}

DETAILED RESPONSES:

General Understanding: ${responses.general}
Frequency of Being Understood: ${responses.frequency}
Support Network: ${(responses.support || []).join(', ')}
Most Misunderstood Context: ${responses.context}
Positive Effects: ${(responses.positive || []).join(', ')}
Negative Effects: ${(responses.negative || []).join(', ')}

Identity Dimensions (1-10 misunderstanding scale):
- Values/Beliefs: ${responses.values}/10
- Personality: ${responses.personality}/10
- Preferences/Lifestyle: ${responses.preferences}/10
- Motivations: ${responses.motivations}/10
- Struggles/Vulnerabilities: ${responses.struggles}/10
- Capabilities/Potential: ${responses.capabilities}/10

Most Misunderstood Dimension: ${results.dims[0].name} (${results.dims[0].score}/10)

Communication Patterns:
- Responsibility Attribution: ${responses.responsibility}
- Expressing Lack of Understanding: ${responses.expression}
- Awareness of Misunderstanding: ${responses.awareness}

YOUR TASK:
Write a 600-800 word personalized analysis that:

1. PATTERN RECOGNITION: Identify the unique signature in their responses - what stands out? What's the through-line connecting their experiences?

2. DEEPER MEANING: Interpret what their pattern reveals about their inner life and relationships. Go beneath the surface numbers.

3. SPECIFIC INSIGHTS: Connect their most misunderstood identity dimension to the contexts and impacts they described. Make it personal to THEM.

4. ACTIONABLE UNDERSTANDING: Based on their communication patterns, what specific shifts could help them feel more understood?

Write in flowing, empathetic prose (no bullet points). Use "you" language. Be psychologically sophisticated but accessible. Focus on insights they couldn't get from the numbers alone - this is where AI adds unique value.`;

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              system: 'You are an expert psychologist specializing in interpersonal communication and the psychology of feeling understood. Provide deep, personalized insights based on assessment patterns. Write in clear, empathetic prose.',
              messages: [{ role: 'user', content: prompt }]
            })
          });

          const data = await response.json();
          const analysis = data.content
            .filter(item => item.type === 'text')
            .map(item => item.text)
            .join('\n');

          setAiAnalysis(analysis);
        } catch (error) {
          console.error('Error:', error);
          setAiAnalysis('We encountered an issue generating your personalized analysis. Your quantitative results are shown above.');
        } finally {
          setIsGenerating(false);
        }
      };
      
      const handleComplete = async () => {
        setShowResults(true);
        const results = calculateResults();
        await generateAIAnalysis(results);
      };
      
      if (step === -1) {
        return (
          <div style={{minHeight: '100vh', padding: '40px 20px'}}>
            <div style={{maxWidth: '700px', margin: '0 auto', textAlign: 'center'}}>
              <h1 style={{fontSize: '36px', fontWeight: 'bold', marginBottom: '12px'}}>The Understanding Gap</h1>
              <p style={{fontSize: '18px', color: '#999b9b', marginBottom: '24px'}}>A comprehensive self-assessment</p>
              <p style={{fontSize: '16px', lineHeight: 1.8, marginBottom: '40px', textAlign: 'left'}}>
                Feeling understood is fundamental to human wellbeing. It shapes our relationships, influences our mental health, and forms the foundation of our sense of belonging. This assessment examines the gap between who you are and how others perceive you, revealing where understanding flourishes and where it fails. Your responses will illuminate patterns in your communication and relationships that may be invisible to you in daily life.
              </p>
              <button onClick={() => setStep(0)} style={{padding: '16px 36px', backgroundColor: '#ffd21f', border: 'none', borderRadius: '8px', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer'}}>
                Begin Assessment
              </button>
            </div>
          </div>
        );
      }
      
      if (showResults) {
        const r = calculateResults();
        return (
          <div style={{minHeight: '100vh', padding: '40px 20px'}}>
            <div style={{maxWidth: '900px', margin: '0 auto'}}>
              <h1 style={{fontSize: '36px', fontWeight: 'bold', marginBottom: '20px', textAlign: 'center'}}>Your Understanding Profile</h1>
              <p style={{fontSize: '18px', color: '#999b9b', marginBottom: '40px', textAlign: 'center'}}>Quantitative analysis + AI-generated insights</p>
              
              {/* Quantitative Results */}
              <div style={{border: '2px solid #e5e5e5', borderRadius: '8px', padding: '48px', marginBottom: '24px'}}>
                <div style={{marginBottom: '48px', paddingBottom: '48px', borderBottom: '1px solid #e5e5e5'}}>
                  <h2 style={{fontSize: '24px', fontWeight: 'bold', marginBottom: '20px'}}>Overall Understanding Quality</h2>
                  <div style={{fontSize: '56px', fontWeight: 'bold', color: '#ffd21f', marginBottom: '12px'}}>{Math.round(r.overallQuality)}%</div>
                  {r.supportCount > 0 && (
                    <div style={{backgroundColor: '#f9f9f9', padding: '20px 24px', borderRadius: '6px', borderLeft: '4px solid #ffd21f', marginTop: '20px'}}>
                      <strong>Your Support Network:</strong> You identified {r.supportCount} relationship{r.supportCount !== 1 ? 's' : ''} where you feel genuinely understood. These are your psychological anchors.
                    </div>
                  )}
                </div>
                
                <div style={{marginBottom: '48px', paddingBottom: '48px', borderBottom: '1px solid #e5e5e5'}}>
                  <h2 style={{fontSize: '24px', fontWeight: 'bold', marginBottom: '20px'}}>Identity Misunderstanding Profile</h2>
                  <div style={{fontSize: '56px', fontWeight: 'bold', color: '#ffd21f', marginBottom: '12px'}}>{r.avgIdentity.toFixed(1)}/10</div>
                  <p style={{fontSize: '14px', color: '#999b9b', marginBottom: '24px'}}>Population average: 5.2/10</p>
                  
                  <h3 style={{fontSize: '18px', fontWeight: 'bold', marginBottom: '12px', marginTop: '24px'}}>Where You Feel Most Misunderstood</h3>
                  {r.dims.map((d,i) => (
                    <div key={i} style={{marginBottom: '16px'}}>
                      <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px', fontSize: '14px'}}>
                        <span>{d.name}</span>
                        <span style={{fontWeight: 'bold'}}>{d.score}/10</span>
                      </div>
                      <div style={{height: '12px', backgroundColor: '#e5e5e5', borderRadius: '6px', overflow: 'hidden'}}>
                        <div style={{height: '100%', backgroundColor: '#ffd21f', width: ((d.score / 10) * 100) + '%', transition: 'width 0.5s'}} />
                      </div>
                    </div>
                  ))}
                </div>
                
                <div>
                  <h2 style={{fontSize: '24px', fontWeight: 'bold', marginBottom: '20px'}}>Impact Assessment</h2>
                  <p style={{fontSize: '16px', lineHeight: 1.8}}>
                    You identified {r.posCount} positive effects when you feel understood and {r.negCount} negative consequences when you are misunderstood.
                  </p>
                  {r.context && r.context !== 'The gap feels relatively consistent across all domains' && (
                    <div style={{backgroundColor: '#f9f9f9', padding: '20px 24px', borderRadius: '6px', borderLeft: '4px solid #ffd21f', marginTop: '20px'}}>
                      <strong>Most Challenging Context:</strong> {r.context}
                    </div>
                  )}
                </div>
              </div>
              
              {/* AI Analysis */}
              <div style={{border: '2px solid #ffd21f', borderRadius: '8px', padding: '48px', marginBottom: '24px', backgroundColor: '#fffef0'}}>
                <h2 style={{fontSize: '24px', fontWeight: 'bold', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '12px'}}>
                  <span>✨</span> Personalized Insights
                </h2>
                {isGenerating ? (
                  <div style={{textAlign: 'center', padding: '40px 20px'}}>
                    <div style={{marginBottom: '20px'}}>
                      <div style={{display: 'inline-block', width: '40px', height: '40px', border: '4px solid #e5e5e5', borderTop: '4px solid #ffd21f', borderRadius: '50%', animation: 'spin 1s linear infinite'}}></div>
                    </div>
                    <p style={{fontSize: '16px', color: '#121212'}}>AI is analyzing your unique pattern...</p>
                  </div>
                ) : aiAnalysis ? (
                  <div style={{fontSize: '16px', lineHeight: 1.8, color: '#121212', whiteSpace: 'pre-wrap'}}>
                    {aiAnalysis}
                  </div>
                ) : (
                  <p style={{fontSize: '16px', color: '#999b9b'}}>Analysis could not be generated.</p>
                )}
              </div>
              
              <button onClick={() => window.location.reload()} style={{padding: '16px 36px', backgroundColor: '#ffd21f', border: 'none', borderRadius: '8px', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer'}}>
                Retake Assessment
              </button>
            </div>
          </div>
        );
      }
      
      const q = questions[step];
      const prog = ((step + 1) / questions.length) * 100;
      const canNext = responses[q.id] !== undefined;
      
      return (
        <div style={{minHeight: '100vh', padding: '40px 20px'}}>
          <div style={{maxWidth: '900px', margin: '0 auto'}}>
            <div style={{height: '4px', backgroundColor: '#e5e5e5', marginBottom: '40px'}}>
              <div style={{height: '100%', backgroundColor: '#ffd21f', width: prog + '%', transition: 'width 0.3s'}} />
            </div>
            
            <div style={{border: '2px solid #e5e5e5', borderRadius: '8px', padding: '48px', marginBottom: '24px'}}>
              <h2 style={{fontSize: '22px', fontWeight: 'bold', marginBottom: '12px', lineHeight: 1.5}}>{q.text}</h2>
              {q.sub && <p style={{fontSize: '15px', color: '#999b9b', marginBottom: '36px', lineHeight: 1.6, fontStyle: 'italic'}}>{q.sub}</p>}
              
              {q.type === 'rating' ? (
                <div>
                  <div style={{display: 'flex', gap: '10px', flexWrap: 'wrap', justifyContent: 'center', marginTop: '8px'}}>
                    {[1,2,3,4,5,6,7,8,9,10].map(num => (
                      <button
                        key={num}
                        onClick={() => handleAnswer(q.id, num)}
                        style={{
                          width: '64px',
                          height: '64px',
                          backgroundColor: responses[q.id] === num ? '#ffd21f' : '#fff',
                          border: responses[q.id] === num ? '2px solid #121212' : '2px solid #e5e5e5',
                          borderRadius: '8px',
                          fontSize: '22px',
                          fontWeight: 'bold',
                          cursor: 'pointer'
                        }}
                      >
                        {num}
                      </button>
                    ))}
                  </div>
                  <div style={{display: 'flex', justifyContent: 'space-between', marginTop: '16px', fontSize: '13px', color: '#999b9b'}}>
                    <span>Not misunderstood at all</span>
                    <span>Extremely misunderstood</span>
                  </div>
                </div>
              ) : (
                <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                  {q.options.map(opt => {
                    const isSel = q.type === 'multi' ? (responses[q.id] || []).includes(opt) : responses[q.id] === opt;
                    return (
                      <button
                        key={opt}
                        onClick={() => q.type === 'multi' ? handleMulti(q.id, opt) : handleAnswer(q.id, opt)}
                        style={{
                          width: '100%',
                          textAlign: 'left',
                          padding: '18px 24px',
                          backgroundColor: isSel ? '#ffd21f' : '#fff',
                          border: isSel ? '2px solid #121212' : '2px solid #e5e5e5',
                          borderRadius: '8px',
                          fontSize: '16px',
                          cursor: 'pointer',
                          lineHeight: 1.5
                        }}
                      >
                        {q.type === 'multi' && <span style={{marginRight: '12px'}}>{isSel ? '✓' : '○'}</span>}
                        {opt}
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
            
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
              <button onClick={() => setStep(step - 1)} disabled={step === 0} style={{padding: '16px 36px', backgroundColor: '#fff', border: '2px solid #121212', borderRadius: '8px', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer', opacity: step === 0 ? 0.5 : 1}}>
                Previous
              </button>
              <span style={{color: '#999b9b', fontSize: '14px'}}>Question {step + 1} of {questions.length}</span>
              <button onClick={() => step === questions.length - 1 ? handleComplete() : setStep(step + 1)} disabled={!canNext} style={{padding: '16px 36px', backgroundColor: '#ffd21f', border: 'none', borderRadius: '8px', fontSize: '16px', fontWeight: 'bold', cursor: 'pointer', opacity: canNext ? 1 : 0.5}}>
                {step === questions.length - 1 ? 'View Results' : 'Next'}
              </button>
            </div>
          </div>
        </div>
      );
    };
    
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
