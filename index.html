<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feeling Understood</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #ffffff;
      color: #121212;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const API_ENDPOINT = '/api/chat';

    const MessageCircle = () => (
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    );

    const Send = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );

    const FeelingUnderstoodChatbot = () => {
      const [messages, setMessages] = useState([
        {
          role: 'assistant',
          content: "Welcome. This is a safe space to explore what it means to feel understood—and what happens when we don't.\n\nThink about the people who matter most to you. How well do you feel understood by them?",
          options: [
            "I often feel understood",
            "Sometimes I do, sometimes I don't",
            "I rarely feel understood",
            "I'd rather describe it in my own words"
          ]
        }
      ]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [showOptions, setShowOptions] = useState(true);
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => {
        if (window.self === window.top) {
          messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const systemPrompt = `You are an empathetic conversation guide for a project about feeling understood. Your role is to help people explore their experiences of feeling understood or misunderstood in their relationships.

Key principles:
- Be warm, compassionate, and non-judgmental
- NEVER give advice. Your role is to listen, reflect, and help people articulate their feelings
- Use active listening techniques: reflect back what you hear, validate emotions, ask clarifying questions
- Help users identify which aspects of their identity they feel misunderstood about (needs, capabilities, role in relationships, values, worldview, ambitions, concerns, etc.)
- When appropriate, gently introduce concepts from the "5 Ways to Feel Understood":
  1. When not feeling understood, say so
  2. Take responsibility for being understood
  3. Ask for help in communicating better
  4. Take your turn in conversations
  5. Always check understanding rather than assume it
- Periodically offer brief summaries of what you've heard to help the user feel understood
- Create a safe space for exploration and self-discovery
- Keep responses conversational and not too long (2-4 sentences usually)
- The goal is for users to feel heard and to gain insight into their communication patterns

Remember: This is about helping people understand themselves better and practice expressing their feelings in a no-jeopardy environment.`;

      const handleOptionClick = async (option) => {
        setShowOptions(false);
        await sendMessage(option);
      };

      const sendMessage = async (messageText = input) => {
        if (!messageText.trim()) return;

        const userMessage = { role: 'user', content: messageText };
        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setIsLoading(true);

        try {
          const conversationHistory = [...messages, userMessage].map(msg => ({
            role: msg.role,
            content: msg.content
          }));

          const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              system: systemPrompt,
              messages: conversationHistory
            })
          });

          const data = await response.json();
          const assistantMessage = data.content
            .filter(item => item.type === 'text')
            .map(item => item.text)
            .join('\n');

          setMessages(prev => [...prev, {
            role: 'assistant',
            content: assistantMessage
          }]);
        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: "I'm having trouble connecting right now. Please try again in a moment."
          }]);
        } finally {
          setIsLoading(false);
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      const styles = {
        container: {
          display: 'flex',
          flexDirection: 'column',
          height: '100vh',
          backgroundColor: '#ffffff',
          fontFamily: 'Arial, Helvetica, sans-serif'
        },
        header: {
          backgroundColor: '#ffffff',
          borderBottom: '1px solid #e5e5e5',
          padding: '20px 24px'
        },
        headerContent: {
          maxWidth: '900px',
          margin: '0 auto',
          display: 'flex',
          alignItems: 'center',
          gap: '16px'
        },
        icon: {
          width: '48px',
          height: '48px',
          backgroundColor: '#ffd21f',
          borderRadius: '50%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: '#121212'
        },
        headerText: {
          flex: 1
        },
        title: {
          fontSize: '24px',
          fontWeight: 'bold',
          color: '#121212',
          margin: 0,
          lineHeight: 1.2
        },
        subtitle: {
          fontSize: '14px',
          color: '#999b9b',
          margin: '4px 0 0 0'
        },
        messagesContainer: {
          flex: 1,
          overflowY: 'auto',
          padding: '32px 24px',
          backgroundColor: '#ffffff'
        },
        messagesInner: {
          maxWidth: '900px',
          margin: '0 auto'
        },
        messageRow: {
          display: 'flex',
          marginBottom: '24px'
        },
        messageRowUser: {
          justifyContent: 'flex-end'
        },
        messageRowAssistant: {
          justifyContent: 'flex-start'
        },
        messageBubble: {
          maxWidth: '75%',
          padding: '16px 20px',
          borderRadius: '8px',
          lineHeight: 1.6
        },
        messageBubbleUser: {
          backgroundColor: '#121212',
          color: '#ffffff'
        },
        messageBubbleAssistant: {
          backgroundColor: '#f5f5f5',
          color: '#121212',
          border: '1px solid #e5e5e5'
        },
        optionsContainer: {
          marginTop: '16px',
          display: 'flex',
          flexDirection: 'column',
          gap: '8px'
        },
        optionButton: {
          width: '100%',
          textAlign: 'left',
          padding: '12px 16px',
          backgroundColor: '#ffffff',
          border: '2px solid #121212',
          borderRadius: '4px',
          color: '#121212',
          fontSize: '14px',
          cursor: 'pointer',
          transition: 'all 0.2s',
          fontFamily: 'Arial, Helvetica, sans-serif'
        },
        loadingContainer: {
          display: 'flex',
          justifyContent: 'flex-start',
          marginBottom: '24px'
        },
        loadingBubble: {
          padding: '16px 20px',
          borderRadius: '8px',
          backgroundColor: '#f5f5f5',
          border: '1px solid #e5e5e5'
        },
        loadingDots: {
          display: 'flex',
          gap: '6px'
        },
        loadingDot: {
          width: '8px',
          height: '8px',
          backgroundColor: '#999b9b',
          borderRadius: '50%',
          animation: 'bounce 1.4s infinite ease-in-out'
        },
        inputContainer: {
          backgroundColor: '#ffffff',
          borderTop: '1px solid #e5e5e5',
          padding: '20px 24px'
        },
        inputInner: {
          maxWidth: '900px',
          margin: '0 auto'
        },
        inputRow: {
          display: 'flex',
          gap: '12px',
          alignItems: 'center'
        },
        input: {
          flex: 1,
          padding: '14px 18px',
          border: '2px solid #e5e5e5',
          borderRadius: '8px',
          fontSize: '15px',
          fontFamily: 'Arial, Helvetica, sans-serif',
          color: '#121212',
          outline: 'none'
        },
        sendButton: {
          width: '52px',
          height: '52px',
          backgroundColor: '#ffd21f',
          border: 'none',
          borderRadius: '8px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          cursor: 'pointer',
          transition: 'all 0.2s',
          color: '#121212'
        },
        disclaimer: {
          textAlign: 'center',
          fontSize: '12px',
          color: '#999b9b',
          marginTop: '12px'
        }
      };

      return (
        <div style={styles.container}>
          <style>
            {`
              @keyframes bounce {
                0%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-8px); }
              }
              .loading-dot-1 { animation-delay: -0.32s; }
              .loading-dot-2 { animation-delay: -0.16s; }
              input:focus {
                border-color: #ffd21f !important;
              }
              button:hover:not(:disabled) {
                opacity: 0.9;
                transform: translateY(-1px);
              }
              button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
              }
              .option-button:hover {
                backgroundColor: #ffd21f !important;
              }
            `}
          </style>
          
          <div style={styles.header}>
            <div style={styles.headerContent}>
              <div style={styles.icon}>
                <MessageCircle />
              </div>
              <div style={styles.headerText}>
                <h1 style={styles.title}>— I want to feel understood</h1>
                <p style={styles.subtitle}>A safe space for exploration</p>
              </div>
            </div>
          </div>

          <div style={styles.messagesContainer}>
            <div style={styles.messagesInner}>
              {messages.map((message, index) => (
                <div 
                  key={index} 
                  style={{
                    ...styles.messageRow,
                    ...(message.role === 'user' ? styles.messageRowUser : styles.messageRowAssistant)
                  }}
                >
                  <div 
                    style={{
                      ...styles.messageBubble,
                      ...(message.role === 'user' ? styles.messageBubbleUser : styles.messageBubbleAssistant)
                    }}
                  >
                    <p style={{ margin: 0, whiteSpace: 'pre-wrap' }}>{message.content}</p>
                    
                    {message.options && showOptions && index === messages.length - 1 && (
                      <div style={styles.optionsContainer}>
                        {message.options.map((option, optIndex) => (
                          <button
                            key={optIndex}
                            onClick={() => handleOptionClick(option)}
                            style={styles.optionButton}
                            className="option-button"
                            onMouseEnter={(e) => e.target.style.backgroundColor = '#ffd21f'}
                            onMouseLeave={(e) => e.target.style.backgroundColor = '#ffffff'}
                          >
                            {option}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              ))}
              
              {isLoading && (
                <div style={styles.loadingContainer}>
                  <div style={styles.loadingBubble}>
                    <div style={styles.loadingDots}>
                      <div style={{...styles.loadingDot}} className="loading-dot-1"></div>
                      <div style={{...styles.loadingDot}} className="loading-dot-2"></div>
                      <div style={{...styles.loadingDot}}></div>
                    </div>
                  </div>
                </div>
              )}
              
              <div ref={messagesEndRef} />
            </div>
          </div>

          <div style={styles.inputContainer}>
            <div style={styles.inputInner}>
              <div style={styles.inputRow}>
                <input
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyPress={handleKeyPress}
                  placeholder="Share your thoughts..."
                  style={styles.input}
                  disabled={isLoading}
                />
                <button
                  onClick={() => sendMessage()}
                  disabled={isLoading || !input.trim()}
                  style={styles.sendButton}
                >
                  <Send />
                </button>
              </div>
              <p style={styles.disclaimer}>
                This is a judgment-free space. Your conversation stays private.
              </p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<FeelingUnderstoodChatbot />, document.getElementById('root'));
  </script>
</body>
</html>
